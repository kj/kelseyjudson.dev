#!/usr/bin/env ruby

require 'json'
require 'tempfile'

root = File.realpath("#{__dir__}/..")

Dir.chdir(root)

manifest = JSON.parse(File.read('manifest.json'))

manifest.values.each do |app|
  index_html = []
  app['docs']['categories'].each do |category|
    index_html << %(<div class="category" id="#{category['slug']}">)
    index_html << %(<h2>#{category['name']}</h2>)
    index_html << %(<ul>)
    category['articles'].each do |article|
      path = "#{app['slug']}/docs/#{category['slug']}/#{article['slug']}"

      system 'pandoc', '--from=markdown+gfm_auto_identifiers+smart',
                       '--template=templates/docs/article.html',
                       "--metadata=app-name:#{app['name']}",
                       "--metadata=app-slug:#{app['slug']}",
                       "--metadata=category-name:#{category['name']}",
                       "--metadata=category-slug:#{category['slug']}",
                       "--metadata=title:#{article['name']}",
                       "--output=#{path}.html",
                       '--to=html',
                       '--toc',
                       "#{path}.md"

      index_html << %(<li><a href="/#{path}.html">#{article['name']}</a></li>)
    end
    index_html << %(</ul>)
    index_html << %(</div>)
  end

  path = "#{app['slug']}/docs/index.html"

  t = Tempfile.new
  t.write(index_html.join("\n"))
  t.close

  system 'pandoc', '--from=html',
                   '--template=templates/docs/index.html',
                   "--metadata=app-name:#{app['name']}",
                   "--metadata=title:Privacy Policy for #{app['name']}",
                   "--output=#{path}",
                   '--to=html',
                   '--toc',
                   t.path

  path = "#{app['slug']}/privacy"

  system 'pandoc', '--from=markdown+gfm_auto_identifiers+smart',
                   '--template=templates/privacy.html',
                   "--metadata=app-name:#{app['name']}",
                   "--metadata=title:Privacy Policy for #{app['name']}",
                   "--output=#{path}.html",
                   '--to=html',
                   '--toc',
                   "#{path}.md"
end

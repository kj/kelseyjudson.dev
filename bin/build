#!/usr/bin/env ruby

require 'json'
require 'tempfile'

root = File.realpath("#{__dir__}/..")

Dir.chdir(root)

manifest = JSON.parse(File.read('manifest.json'))

manifest.values.each do |app|
  index_html = []
  app['docs']['categories'].each do |category|
    category_index_html = []
    category_index_html << %(<div class="category" id="#{category['slug']}">)
    category_index_html << %(<h2>#{category['name']}</h2>)
    category_index_html << %(<ul>)
    category['articles'].each do |article|
      path = "#{app['slug']}/docs/#{category['slug']}/#{article['slug']}"

      pandoc_options = [
        '--from=markdown+gfm_auto_identifiers+smart',
        '--template=templates/apps_docs_article.html',
        "--metadata=app-name:#{app['name']}",
        "--metadata=app-slug:#{app['slug']}",
        "--metadata=category-name:#{category['name']}",
        "--metadata=category-slug:#{category['slug']}",
        "--metadata=title:#{article['name']}",
        "--output=#{path}.html",
        '--to=html',
        article['toc'] ? '--toc' : nil,
        "#{path}.md",
      ]

      system 'pandoc', *pandoc_options.compact

      category_index_html << %(<li><a href="/#{path}.html">#{article['name']}</a></li>)
    end
    category_index_html << %(</ul>)
    category_index_html << %(</div>)

    path = "#{app['slug']}/docs/#{category['slug']}/index.html"

    t = Tempfile.new
    t.write(category_index_html.join("\n"))
    t.close

    pandoc_options = [
      '--from=html',
      '--template=templates/apps_docs_index.html',
      "--metadata=app-name:#{app['name']}",
      "--metadata=app-slug:#{app['slug']}",
      "--metadata=category-name:#{category['name']}",
      "--metadata=category-slug:#{category['slug']}",
      "--metadata=is-category-index:true",
      "--metadata=title:#{app['name']} Docs",
      "--output=#{path}",
      '--to=html',
      t.path,
    ]

    system 'pandoc', *pandoc_options.compact

    index_html << category_index_html
  end

  path = "#{app['slug']}/docs/index.html"

  t = Tempfile.new
  t.write(index_html.flatten.join("\n"))
  t.close

  pandoc_options = [
    '--from=html',
    '--template=templates/apps_docs_index.html',
    "--metadata=app-name:#{app['name']}",
    "--metadata=title:#{app['name']} Docs",
    "--output=#{path}",
    '--to=html',
    t.path,
  ]

  system 'pandoc', *pandoc_options.compact

  path = "#{app['slug']}/privacy"

  pandoc_options = [
    '--from=markdown+gfm_auto_identifiers+smart',
    '--template=templates/apps_privacy.html',
    "--metadata=app-name:#{app['name']}",
    "--metadata=title:Privacy Policy for #{app['name']}",
    "--output=#{path}.html",
    '--to=html',
    "#{path}.md",
  ]

  system 'pandoc', *pandoc_options.compact
end

pandoc_options = [
'--from=markdown+gfm_auto_identifiers+smart',
'--template=templates/home.html',
"--metadata=title:Home",
"--output=index.html",
'--to=html',
"index.md",
]

system 'pandoc', *pandoc_options.compact
